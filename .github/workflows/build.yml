name: Build

on:
  push:
    branches: ["**"]
    tags: ["v*"]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/**'
      - 'LICENSE'
  workflow_dispatch:
    inputs:
      tag_version:
        description: "Tag Version (e.g., v1.2.3)"
        required: true
        type: string

# 并发控制
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-build
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

env:
  GO_VERSION: '1.22'
  CGO_ENABLED: 1

jobs:
  check:
    runs-on: ubuntu-latest
    if: |
      !startsWith(github.event.head_commit.message, 'docs:') &&
      !startsWith(github.event.head_commit.message, 'ci:') &&
      !startsWith(github.event.head_commit.message, 'chore:') &&
      !startsWith(github.event.head_commit.message, 'style:') &&
      !contains(github.event.head_commit.message, 'skip ci')
    outputs:
      version: ${{ steps.version.outputs.version }}
      commit: ${{ steps.version.outputs.commit }}
      build_time: ${{ steps.version.outputs.build_time }}
      version_suffix: ${{ steps.version.outputs.version_suffix }}
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version info
        id: version
        run: |
          VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "dev")
          COMMIT=$(git rev-parse --short HEAD)
          BUILD_TIME=$(date -u --iso-8601=ns)
          VERSION_SUFFIX="${VERSION}"
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "commit=${COMMIT}" >> $GITHUB_OUTPUT
          echo "build_time=${BUILD_TIME}" >> $GITHUB_OUTPUT
          echo "version_suffix=${VERSION_SUFFIX}" >> $GITHUB_OUTPUT
          
          echo "Version: ${VERSION}"
          echo "Commit: ${COMMIT}"
          echo "Build Time: ${BUILD_TIME}"
          echo "Version Suffix: ${VERSION_SUFFIX}"

  # 删除原有的 test job，替换为等待 test workflow 完成
  wait-tests:
    needs: check
    runs-on: ubuntu-latest
    steps:
      - name: Wait for tests
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.ref }}
          check-name: 'test'
          repo-token: ${{ secrets.ACTION_GITHUB_TOKEN }}
          wait-interval: 10

  build:
    needs: [check, wait-tests]
    strategy:
      fail-fast: false
      matrix:
        include:
          - {os: ubuntu-latest, platform: linux, arch: amd64}
          - {os: ubuntu-latest, platform: linux, arch: arm64}
          - {os: windows-latest, platform: windows, arch: amd64}
          - {os: macos-latest, platform: darwin, arch: amd64}
          - {os: macos-latest, platform: darwin, arch: arm64}
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
      
      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-${{ matrix.arch }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.arch }}-go-

      - name: Install dependencies
        run: |
          go mod download
          go mod verify

      - name: Set up cross-compilation
        if: matrix.arch == 'arm64' && matrix.platform != 'darwin'
        run: |
          if [ "${{ matrix.platform }}" = "linux" ]; then
            sudo apt-get update
            sudo apt-get install -y gcc-aarch64-linux-gnu
            echo "CC=aarch64-linux-gnu-gcc" >> $GITHUB_ENV
          fi
        shell: bash

      - name: Build (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        env:
          GOOS: ${{ matrix.platform }}
          GOARCH: ${{ matrix.arch }}
        run: |
          $BinaryName = "sql-runner-${{ needs.check.outputs.version_suffix }}-${{ matrix.platform }}-${{ matrix.arch }}.exe"
          $LdFlags = "-X main.Version=${{ needs.check.outputs.version }} " + `
                    "-X main.Commit=${{ needs.check.outputs.commit }} " + `
                    "-X main.BuildTime=${{ needs.check.outputs.build_time }} " + `
                    "-s -w"
          
          go build -v -o $BinaryName -ldflags="$LdFlags" ./cmd/sql-runner/

      - name: Build (Unix)
        if: matrix.platform != 'windows'
        shell: bash
        env:
          GOOS: ${{ matrix.platform }}
          GOARCH: ${{ matrix.arch }}
        run: |
          BINARY_NAME="sql-runner-${{ needs.check.outputs.version_suffix }}-${{ matrix.platform }}-${{ matrix.arch }}"
          
          LDFLAGS="-X main.Version=${{ needs.check.outputs.version }} \
                   -X main.Commit=${{ needs.check.outputs.commit }} \
                   -X main.BuildTime=${{ needs.check.outputs.build_time }} \
                   -s -w"
          
          go build -v -o "${BINARY_NAME}" -ldflags="${LDFLAGS}" ./cmd/sql-runner/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: sql-runner-${{ needs.check.outputs.version_suffix }}-${{ matrix.platform }}-${{ matrix.arch }}
          path: |
            sql-runner-*
          compression-level: 9


  build-rocky8:
    needs: [check, wait-tests]
    runs-on: ubuntu-latest
    
    container: 
      image: rockylinux:8

    steps:
      - name: Install dependencies
        run: |
          dnf install -y gcc gcc-c++ git make curl
          curl -L https://go.dev/dl/go1.22.9.linux-amd64.tar.gz | tar -C /usr/local -xzf -

      - uses: actions/checkout@v4

      - name: Build
        run: |
          export PATH=/usr/local/go/bin:$PATH
          export CGO_ENABLED=1
          rm -rf .git

          BINARY_NAME="sql-runner-${{ needs.check.outputs.version_suffix }}-rocky8-amd64"
          
          LDFLAGS="-X main.Version=${{ needs.check.outputs.version }} \
                   -X main.Commit=${{ needs.check.outputs.commit }} \
                   -X main.BuildTime=${{ needs.check.outputs.build_time }} \
                   -s -w"
          
          go build -v -o "${BINARY_NAME}" -ldflags="${LDFLAGS}" ./cmd/sql-runner/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: sql-runner-${{ needs.check.outputs.version_suffix }}-rocky8-amd64
          path: |
            sql-runner-*
          compression-level: 9


  changelog:
    needs: check
    runs-on: ubuntu-latest
    if: github.ref_type == 'tag' || github.event.inputs.tag_version != ''
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
      
      - name: Install github-changelog-generator
        run: gem install github_changelog_generator

      - name: Create changelog directory
        run: mkdir -p changelog
      
      - name: Generate changelog
        env:
          CHANGELOG_GITHUB_TOKEN: ${{ secrets.ACTION_GITHUB_TOKEN }}
        run: |
          # 获取版本号
          VERSION="${{ needs.check.outputs.version }}"
          
          # 配置生成器
          github_changelog_generator \
            --user ${{ github.repository_owner }} \
            --project $(basename ${{ github.repository }}) \
            --token $CHANGELOG_GITHUB_TOKEN \
            --since-tag $(git describe --abbrev=0 --tags `git rev-list --tags --skip=1 --max-count=1` 2>/dev/null || echo "") \
            --future-release "${VERSION}" \
            --output changelog/CHANGELOG.md

      - name: Process changelog
        run: |
          # 移除不需要的部分
          sed -i '/^\* \*This Changelog/d' changelog/CHANGELOG.md
       
      - name: Upload changelog
        uses: actions/upload-artifact@v4
        with:
          name: changelog
          path: changelog/CHANGELOG.md

  release:
    needs: [check, build, build-rocky8, changelog]
    if: github.ref_type == 'tag' || github.event.inputs.tag_version != ''
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      id-token: write
      attestations: write
    
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
      
      - name: Prepare release assets
        run: |
          mkdir -p release
          cp -r sql-runner-*/* release/
          for file in release/*; do
            sha256sum "$file" > "$file.sha256"
          done
      
      - name: Generate provenance
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: release/*
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ needs.check.outputs.version }}
          body_path: changelog/CHANGELOG.md
          files: release/*
          draft: false
          prerelease: ${{ contains(needs.check.outputs.version, 'beta') || contains(needs.check.outputs.version, 'alpha') }}
