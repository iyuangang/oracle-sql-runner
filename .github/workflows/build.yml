name: Build

on:
  push:
    branches: ["**"]
    tags: ["v*"]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/**'
      - 'LICENSE'
  workflow_dispatch:
    inputs:
      tag_version:
        description: "Tag Version (e.g., v1.2.3)"
        required: true
        type: string

# å¹¶å‘æŽ§åˆ¶
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-build
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

env:
  GO_VERSION: '1.22'
  CGO_ENABLED: 1

jobs:
  check:
    runs-on: ubuntu-latest
    if: |
      !startsWith(github.event.head_commit.message, 'docs:') &&
      !startsWith(github.event.head_commit.message, 'ci:') &&
      !startsWith(github.event.head_commit.message, 'chore:') &&
      !startsWith(github.event.head_commit.message, 'style:') &&
      !contains(github.event.head_commit.message, 'skip ci')
    outputs:
      version: ${{ steps.version.outputs.version }}
      commit: ${{ steps.version.outputs.commit }}
      build_time: ${{ steps.version.outputs.build_time }}
      version_suffix: ${{ steps.version.outputs.version_suffix }}
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: ${{ github.event.inputs.tag_version != '' || github.ref_type == 'tag' && 0 || 1 }}

      - name: Get version info
        id: version
        run: |
          VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "dev")
          COMMIT=$(git rev-parse --short HEAD)
          BUILD_TIME=$(date -u --iso-8601=ns)
          
          # æž„å»ºç‰ˆæœ¬åŽç¼€
          if [[ "${VERSION}" == "dev" ]]; then
            VERSION_SUFFIX="dev-${COMMIT}"
          else
            VERSION_SUFFIX="${VERSION}"
          fi
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "commit=${COMMIT}" >> $GITHUB_OUTPUT
          echo "build_time=${BUILD_TIME}" >> $GITHUB_OUTPUT
          echo "version_suffix=${VERSION_SUFFIX}" >> $GITHUB_OUTPUT
          
          echo "Version: ${VERSION}"
          echo "Commit: ${COMMIT}"
          echo "Build Time: ${BUILD_TIME}"
          echo "Version Suffix: ${VERSION_SUFFIX}"

  # åˆ é™¤åŽŸæœ‰çš„ test jobï¼Œæ›¿æ¢ä¸ºç­‰å¾… test workflow å®Œæˆ
  wait-tests:
    needs: check
    runs-on: ubuntu-latest
    steps:
      - name: Wait for tests
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.ref }}
          check-name: 'test'
          repo-token: ${{ secrets.ACTION_GITHUB_TOKEN }}
          wait-interval: 10

  build:
    needs: [check, wait-tests]
    strategy:
      fail-fast: false
      matrix:
        include:
          - {os: ubuntu-latest, platform: linux, arch: amd64}
          - {os: ubuntu-latest, platform: linux, arch: arm64}
          - {os: windows-latest, platform: windows, arch: amd64}
          - {os: macos-latest, platform: darwin, arch: amd64}
          - {os: macos-latest, platform: darwin, arch: arm64}
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
      
      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-${{ matrix.arch }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.arch }}-go-

      - name: Install dependencies
        run: |
          go mod download
          go mod verify

      - name: Set up cross-compilation
        if: matrix.arch == 'arm64' && matrix.platform != 'darwin'
        run: |
          if [ "${{ matrix.platform }}" = "linux" ]; then
            sudo apt-get update
            sudo apt-get install -y gcc-aarch64-linux-gnu
            echo "CC=aarch64-linux-gnu-gcc" >> $GITHUB_ENV
          fi
        shell: bash

      - name: Build (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        env:
          GOOS: ${{ matrix.platform }}
          GOARCH: ${{ matrix.arch }}
        run: |
          $BinaryName = "sql-runner-${{ needs.check.outputs.version_suffix }}-${{ matrix.platform }}-${{ matrix.arch }}.exe"
          $LdFlags = "-X main.Version=${{ needs.check.outputs.version }} " + `
                    "-X main.Commit=${{ needs.check.outputs.commit }} " + `
                    "-X main.BuildTime=${{ needs.check.outputs.build_time }} " + `
                    "-s -w"
          
          go build -v -o $BinaryName -ldflags="$LdFlags" ./cmd/sql-runner/

      - name: Build (Unix)
        if: matrix.platform != 'windows'
        shell: bash
        env:
          GOOS: ${{ matrix.platform }}
          GOARCH: ${{ matrix.arch }}
        run: |
          BINARY_NAME="sql-runner-${{ needs.check.outputs.version_suffix }}-${{ matrix.platform }}-${{ matrix.arch }}"
          
          LDFLAGS="-X main.Version=${{ needs.check.outputs.version }} \
                   -X main.Commit=${{ needs.check.outputs.commit }} \
                   -X main.BuildTime=${{ needs.check.outputs.build_time }} \
                   -s -w"
          
          go build -v -o "${BINARY_NAME}" -ldflags="${LDFLAGS}" ./cmd/sql-runner/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: sql-runner-${{ needs.check.outputs.version_suffix }}-${{ matrix.platform }}-${{ matrix.arch }}
          path: |
            sql-runner-*
          compression-level: 9


  build-rocky8:
    needs: [check, wait-tests]  # ä¿®æ”¹ä¾èµ–
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        arch: [amd64, arm64]
    
    container: 
      image: rockylinux:8
      options: --platform linux/${{ matrix.arch }}

    steps:
      - name: Install dependencies
        run: |
          dnf install -y gcc gcc-c++ git make curl
          curl -L https://go.dev/dl/go1.22.9.linux-amd64.tar.gz | tar -C /usr/local -xzf -
          export PATH=$PATH:/usr/local/go/bin

      - uses: actions/checkout@v4

      - name: Build
        env:
          CGO_ENABLED: 1
          PATH: /usr/local/go/bin:$PATH
        run: |
          BINARY_NAME="sql-runner-${{ needs.check.outputs.version_suffix }}-rocky8-${{ matrix.arch }}"
          
          LDFLAGS="-X main.Version=${{ needs.check.outputs.version }} \
                   -X main.Commit=${{ needs.check.outputs.commit }} \
                   -X main.BuildTime=${{ needs.check.outputs.build_time }} \
                   -s -w"
          
          go build -v -o "${BINARY_NAME}" -ldflags="${LDFLAGS}" ./cmd/sql-runner/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: sql-runner-${{ needs.check.outputs.version_suffix }}-rocky8-${{ matrix.arch }}
          path: |
            sql-runner-*
          compression-level: 9


  changelog:
    needs: check
    if: github.ref_type == 'tag' || github.event.inputs.tag_version != ''
    runs-on: ubuntu-latest
    outputs:
      release_notes: ${{ steps.changelog.outputs.changelog }}
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate changelog
        id: changelog
        run: |
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -n "${PREVIOUS_TAG}" ]; then
            RANGE="${PREVIOUS_TAG}..HEAD"
          else
            RANGE="HEAD"
          fi
          
          {
            echo "## What's Changed"
            echo
            echo "### ðŸš€ Features"
            git log ${RANGE} --pretty=format:"* %s" --grep="^feat:"
            echo
            echo "### ðŸ› Bug Fixes"
            git log ${RANGE} --pretty=format:"* %s" --grep="^fix:"
            echo
            echo "### ðŸ“ Documentation"
            git log ${RANGE} --pretty=format:"* %s" --grep="^docs:"
            echo
            echo "### âš¡ Performance"
            git log ${RANGE} --pretty=format:"* %s" --grep="^perf:"
            echo
            echo "### ðŸ”¨ Other Changes"
            git log ${RANGE} --pretty=format:"* %s" \
              --grep="^refactor:" \
              --grep="^style:" \
              --grep="^test:" \
              --grep="^chore:"
            echo
            echo "### ðŸ‘¥ Contributors"
            git log ${RANGE} --pretty=format:"* %an" | sort -u
          } > CHANGELOG.md
          
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          cat CHANGELOG.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Upload changelog
        uses: actions/upload-artifact@v4
        with:
          name: changelog
          path: CHANGELOG.md
          retention-days: 1

  release:
    needs: [build, build-rocky8, changelog]
    if: github.ref_type == 'tag' || github.event.inputs.tag_version != ''
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      id-token: write
    
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
      
      - name: Prepare release assets
        run: |
          mkdir -p release
          cp -r sql-runner-*/* release/
          for file in release/*; do
            sha256sum "$file" > "$file.sha256"
          done
      
      - name: Generate provenance
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: release/*
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: v${{ needs.check.outputs.version }}
          body_path: changelog/CHANGELOG.md
          files: release/*
          draft: true
          prerelease: ${{ contains(needs.check.outputs.version, 'beta') || contains(needs.check.outputs.version, 'alpha') }}
