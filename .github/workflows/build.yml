name: Build

on:
  push:
    branches: ["**"]
    tags: ["v*"]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/**'
      - 'LICENSE'
  workflow_dispatch:
    inputs:
      tag_version:
        description: "Tag Version (e.g., v1.2.3)"
        required: true
        type: string

# å¹¶å‘æ§åˆ¶
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}-build
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

env:
  GO_VERSION: '1.22'
  CGO_ENABLED: 1

jobs:
  check:
    runs-on: ubuntu-latest
    if: |
      !startsWith(github.event.head_commit.message, 'docs:') &&
      !startsWith(github.event.head_commit.message, 'ci:') &&
      !startsWith(github.event.head_commit.message, 'chore:') &&
      !startsWith(github.event.head_commit.message, 'style:') &&
      !contains(github.event.head_commit.message, 'skip ci')
    outputs:
      version: ${{ steps.version.outputs.version }}
      commit: ${{ steps.version.outputs.commit }}
      build_time: ${{ steps.version.outputs.build_time }}
      version_suffix: ${{ steps.version.outputs.version_suffix }}
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version info
        id: version
        run: |
          VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "dev")
          COMMIT=$(git rev-parse --short HEAD)
          BUILD_TIME=$(date -u --iso-8601=ns)
          VERSION_SUFFIX="${VERSION}"
          
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "commit=${COMMIT}" >> $GITHUB_OUTPUT
          echo "build_time=${BUILD_TIME}" >> $GITHUB_OUTPUT
          echo "version_suffix=${VERSION_SUFFIX}" >> $GITHUB_OUTPUT
          
          echo "Version: ${VERSION}"
          echo "Commit: ${COMMIT}"
          echo "Build Time: ${BUILD_TIME}"
          echo "Version Suffix: ${VERSION_SUFFIX}"

  # åˆ é™¤åŸæœ‰çš„ test jobï¼Œæ›¿æ¢ä¸ºç­‰å¾… test workflow å®Œæˆ
  wait-tests:
    needs: check
    runs-on: ubuntu-latest
    steps:
      - name: Wait for tests
        uses: lewagon/wait-on-check-action@v1.3.4
        with:
          ref: ${{ github.ref }}
          check-name: 'test'
          repo-token: ${{ secrets.ACTION_GITHUB_TOKEN }}
          wait-interval: 10

  build:
    needs: [check, wait-tests]
    strategy:
      fail-fast: false
      matrix:
        include:
          - {os: ubuntu-latest, platform: linux, arch: amd64}
          - {os: ubuntu-latest, platform: linux, arch: arm64}
          - {os: windows-latest, platform: windows, arch: amd64}
          - {os: macos-latest, platform: darwin, arch: amd64}
          - {os: macos-latest, platform: darwin, arch: arm64}
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true
      
      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-${{ matrix.arch }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-${{ matrix.arch }}-go-

      - name: Install dependencies
        run: |
          go mod download
          go mod verify

      - name: Set up cross-compilation
        if: matrix.arch == 'arm64' && matrix.platform != 'darwin'
        run: |
          if [ "${{ matrix.platform }}" = "linux" ]; then
            sudo apt-get update
            sudo apt-get install -y gcc-aarch64-linux-gnu
            echo "CC=aarch64-linux-gnu-gcc" >> $GITHUB_ENV
          fi
        shell: bash

      - name: Build (Windows)
        if: matrix.platform == 'windows'
        shell: pwsh
        env:
          GOOS: ${{ matrix.platform }}
          GOARCH: ${{ matrix.arch }}
        run: |
          $BinaryName = "sql-runner-${{ needs.check.outputs.version_suffix }}-${{ matrix.platform }}-${{ matrix.arch }}.exe"
          $LdFlags = "-X main.Version=${{ needs.check.outputs.version }} " + `
                    "-X main.Commit=${{ needs.check.outputs.commit }} " + `
                    "-X main.BuildTime=${{ needs.check.outputs.build_time }} " + `
                    "-s -w"
          
          go build -v -o $BinaryName -ldflags="$LdFlags" ./cmd/sql-runner/

      - name: Build (Unix)
        if: matrix.platform != 'windows'
        shell: bash
        env:
          GOOS: ${{ matrix.platform }}
          GOARCH: ${{ matrix.arch }}
        run: |
          BINARY_NAME="sql-runner-${{ needs.check.outputs.version_suffix }}-${{ matrix.platform }}-${{ matrix.arch }}"
          
          LDFLAGS="-X main.Version=${{ needs.check.outputs.version }} \
                   -X main.Commit=${{ needs.check.outputs.commit }} \
                   -X main.BuildTime=${{ needs.check.outputs.build_time }} \
                   -s -w"
          
          go build -v -o "${BINARY_NAME}" -ldflags="${LDFLAGS}" ./cmd/sql-runner/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: sql-runner-${{ needs.check.outputs.version_suffix }}-${{ matrix.platform }}-${{ matrix.arch }}
          path: |
            sql-runner-*
          compression-level: 9


  build-rocky8:
    needs: [check, wait-tests]
    runs-on: ubuntu-latest
    
    container: 
      image: rockylinux:8

    steps:
      - name: Install dependencies
        run: |
          dnf install -y gcc gcc-c++ git make curl
          curl -L https://go.dev/dl/go1.22.9.linux-amd64.tar.gz | tar -C /usr/local -xzf -

      - uses: actions/checkout@v4

      - name: Build
        run: |
          export PATH=/usr/local/go/bin:$PATH
          export CGO_ENABLED=1
          rm -rf .git

          BINARY_NAME="sql-runner-${{ needs.check.outputs.version_suffix }}-rocky8-amd64"
          
          LDFLAGS="-X main.Version=${{ needs.check.outputs.version }} \
                   -X main.Commit=${{ needs.check.outputs.commit }} \
                   -X main.BuildTime=${{ needs.check.outputs.build_time }} \
                   -s -w"
          
          go build -v -o "${BINARY_NAME}" -ldflags="${LDFLAGS}" ./cmd/sql-runner/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: sql-runner-${{ needs.check.outputs.version_suffix }}-rocky8-amd64
          path: |
            sql-runner-*
          compression-level: 9


  changelog:
    needs: check
    runs-on: ubuntu-latest
    if: github.ref_type == 'tag' || github.event.inputs.tag_version != ''
    
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Generate changelog
        run: |
          # è·å–ç‰ˆæœ¬ä¿¡æ¯
          VERSION="${{ needs.check.outputs.version }}"
          CURRENT_TAG="${VERSION}"
          PREVIOUS_TAG=$(git describe --abbrev=0 --tags `git rev-list --tags --skip=1 --max-count=1` 2>/dev/null || echo "")
          CURRENT_DATE=$(date +'%Y-%m-%d')
          
          # åˆ›å»º changelog ç›®å½•
          mkdir -p changelog
          
          # è·å–æäº¤è€…çš„ GitHub ç”¨æˆ·åæ˜ å°„
          declare -A AUTHOR_MAP
          while IFS= read -r line; do
            HASH=$(echo "$line" | cut -d' ' -f1)
            USERNAME=$(git log -1 --format='%an' $HASH | \
              curl -s -H "Authorization: token ${{ secrets.ACTION_GITHUB_TOKEN }}" \
                   -H "Accept: application/vnd.github.v3+json" \
                   "https://api.github.com/search/users?q=$(cat)%20in:name" | \
              jq -r '.items[0].login // empty')
            if [ ! -z "$USERNAME" ]; then
              AUTHOR_MAP[$HASH]="@$USERNAME"
            fi
          done < <(git log ${PREVIOUS_TAG}..HEAD --format="%H")
          
          # å¼€å§‹ç”Ÿæˆ changelog
          {
            echo "# æ›´æ–°æ—¥å¿—"
            echo
            echo "## ${CURRENT_TAG} (${CURRENT_DATE})"
            echo
            echo "### ä¸»è¦æ›´æ–°"
            echo
            
            # æ–°ç‰¹æ€§
            echo "#### â­ æ–°ç‰¹æ€§"
            git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --reverse | grep -E "^- feat" | \
              sed -E 's/^feat(\([^)]+\))?://' | while read -r line; do
                HASH=$(echo "$line" | grep -o '([a-f0-9]\{7\})' | tr -d '()')
                AUTHOR="${AUTHOR_MAP[$HASH]}"
                echo "    $line ${AUTHOR}"
              done || echo "    - æ— "
            echo
            
            # ä¼˜åŒ–
            echo "#### âš¡ï¸ ä¼˜åŒ–"
            git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --reverse | grep -E "^(- perf|- refactor)" | \
              sed -E 's/^(perf|refactor)(\([^)]+\))?://' | while read -r line; do
                HASH=$(echo "$line" | grep -o '([a-f0-9]\{7\})' | tr -d '()')
                AUTHOR="${AUTHOR_MAP[$HASH]}"
                echo "    $line ${AUTHOR}"
              done || echo "    - æ— "
            echo
            
            # Bug ä¿®å¤
            echo "#### ğŸ Bug ä¿®å¤"
            git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --reverse | grep -E "^- fix" | \
              sed -E 's/^fix(\([^)]+\))?://' | while read -r line; do
                HASH=$(echo "$line" | grep -o '([a-f0-9]\{7\})' | tr -d '()')
                AUTHOR="${AUTHOR_MAP[$HASH]}"
                echo "    $line ${AUTHOR}"
              done || echo "    - æ— "
            echo
            
            # æ–‡æ¡£æ›´æ–°
            echo "#### ğŸ“š æ–‡æ¡£æ›´æ–°"
            git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --reverse | grep -E "^ docs" | \
              sed -E 's/^docs(\([^)]+\))?://' | while read -r line; do
                HASH=$(echo "$line" | grep -o '([a-f0-9]\{7\})' | tr -d '()')
                AUTHOR="${AUTHOR_MAP[$HASH]}"
                echo "    $line ${AUTHOR}"
              done || echo "    - æ— "
            echo
            
            # ä¾èµ–æ›´æ–°
            echo "#### â¬†ï¸ ä¾èµ–æ›´æ–°"
            git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --reverse | grep -E "^(- build|- deps)" | \
              sed -E 's/^(build|deps)(\([^)]+\))?://' | while read -r line; do
                HASH=$(echo "$line" | grep -o '([a-f0-9]\{7\})' | tr -d '()')
                AUTHOR="${AUTHOR_MAP[$HASH]}"
                echo "    $line ${AUTHOR}"
              done || echo "    - æ— "
            echo
            
            # å…¶ä»–æ›´æ”¹
            echo "#### ğŸ”¨ å…¶ä»–æ›´æ”¹"
            git log ${PREVIOUS_TAG}..HEAD --pretty=format:"- %s (%h)" --reverse | \
              grep -vE "^(- feat|- fix|- docs|- style|- refactor|- perf|- test|- build|- ci|- chore|- deps):" | while read -r line; do
                HASH=$(echo "$line" | grep -o '([a-f0-9]\{7\})' | tr -d '()')
                AUTHOR="${AUTHOR_MAP[$HASH]}"
                echo "    $line ${AUTHOR}"
              done || echo "    - æ— "
            echo
            
            # è´¡çŒ®è€…
            echo "### ğŸ‘¥ è´¡çŒ®è€…"
            echo -n "æ„Ÿè°¢ä»¥ä¸‹è´¡çŒ®è€…ï¼š"
            for username in $(printf '%s\n' "${AUTHOR_MAP[@]}" | sort -u); do
              echo -n " $username"
            done
            echo
            echo
            
            # å®Œæ•´å˜æ›´è®°å½•é“¾æ¥
            echo "[Full Changelog](https://github.com/${{ github.repository }}/compare/${PREVIOUS_TAG}...${CURRENT_TAG})"
            
          } > changelog/CHANGELOG.md
          
          # ç§»é™¤ç©ºåˆ†ç±»
          sed -i '/    - æ— /d' changelog/CHANGELOG.md
          sed -i '/#### .*/{ N; /####.*\n$/d }' changelog/CHANGELOG.md
          
          # æ˜¾ç¤ºç”Ÿæˆçš„å†…å®¹
          cat changelog/CHANGELOG.md
      
      - name: Upload changelog
        uses: actions/upload-artifact@v4
        with:
          name: changelog
          path: changelog/CHANGELOG.md

  release:
    needs: [check, build, build-rocky8, changelog]
    if: github.ref_type == 'tag' || github.event.inputs.tag_version != ''
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      id-token: write
      attestations: write
    
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
      
      - name: Prepare release assets
        run: |
          mkdir -p release
          cp -r sql-runner-*/* release/
          for file in release/*; do
            sha256sum "$file" > "$file.sha256"
          done
      
      - name: Generate provenance
        uses: actions/attest-build-provenance@v1
        with:
          subject-path: release/*
      
      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          name: ${{ needs.check.outputs.version }}
          body_path: changelog/CHANGELOG.md
          files: release/*
          draft: false
          prerelease: ${{ contains(needs.check.outputs.version, 'beta') || contains(needs.check.outputs.version, 'alpha') }}
