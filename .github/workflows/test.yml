name: Test

on:
  push:
    branches: ["**"]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - 'LICENSE'
  pull_request:
    branches: ["main"]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      oracle:
        image: gvenzl/oracle-xe:21-slim
        env:
          ORACLE_PASSWORD: oracle
          APP_USER: test
          APP_USER_PASSWORD: test123
        ports:
          - 1521:1521
        options: >-
          --health-cmd healthcheck.sh
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
      - uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.22'
          cache: true
      
      - name: Install Oracle Instant Client
        run: |
          # 安装依赖
          sudo apt-get update
          sudo apt-get install -y libaio1
          
          # 下载并解压 Basic 包
          wget https://download.oracle.com/otn_software/linux/instantclient/219000/instantclient-basic-linux.x64-21.9.0.0.0dbru.zip
          sudo mkdir -p /opt/oracle
          sudo unzip instantclient-basic-linux.x64-21.9.0.0.0dbru.zip -d /opt/oracle
          
          # 下载并解压 SQL*Plus 包
          wget https://download.oracle.com/otn_software/linux/instantclient/219000/instantclient-sqlplus-linux.x64-21.9.0.0.0dbru.zip
          sudo unzip instantclient-sqlplus-linux.x64-21.9.0.0.0dbru.zip -d /opt/oracle
          
          # 配置环境变量
          echo "/opt/oracle/instantclient_21_9" | sudo tee /etc/ld.so.conf.d/oracle-instantclient.conf
          sudo ldconfig
          
          echo "export LD_LIBRARY_PATH=/opt/oracle/instantclient_21_9:$LD_LIBRARY_PATH" >> $GITHUB_ENV
          echo "export PATH=/opt/oracle/instantclient_21_9:$PATH" >> $GITHUB_ENV
          
          # 创建 TNS 配置
          sudo mkdir -p /opt/oracle/instantclient_21_9/network/admin
          echo "XE =
            (DESCRIPTION =
              (ADDRESS = (PROTOCOL = TCP)(HOST = localhost)(PORT = 1521))
              (CONNECT_DATA =
                (SERVER = DEDICATED)
                (SERVICE_NAME = XE)
              )
            )" | sudo tee /opt/oracle/instantclient_21_9/network/admin/tnsnames.ora

      - name: Wait for Oracle
        run: |
          source $GITHUB_ENV
          for i in {1..60}; do
            echo "Attempt $i: Waiting for Oracle..."
            if echo "SELECT 1 FROM DUAL;" | sqlplus -s "test/test123@//localhost:1521/XE" > /dev/null 2>&1; then
              echo "Oracle is ready!"
              break
            fi
            sleep 5
          done

      - name: Create test config
        run: |
          cat > config.json << EOF
          {
            "databases": {
              "test": {
                "name": "测试库",
                "user": "test",
                "password": "test123",
                "host": "localhost",
                "port": 1521,
                "service": "XE"
              }
            },
            "max_retries": 3,
            "max_concurrent": 5,
            "batch_size": 1000,
            "timeout": 30,
            "log_level": "debug"
          }
          EOF

      - name: Run unit tests
        run: go test -v -coverprofile=coverage.unit.txt ./pkg/... ./internal/...

      - name: Prepare test fixtures
        run: |
          source $GITHUB_ENV
          sqlplus -s test/test123@//localhost:1521/XE << EOF
          WHENEVER SQLERROR EXIT SQL.SQLCODE;
          
          -- 创建测试表
          CREATE TABLE test_table (
            id NUMBER PRIMARY KEY,
            name VARCHAR2(100)
          );
          
          -- 插入测试数据
          INSERT INTO test_table VALUES (1, 'Test 1');
          INSERT INTO test_table VALUES (2, 'Test 2');
          
          -- 创建测试存储过程
          CREATE OR REPLACE PROCEDURE test_proc AS
          BEGIN
            NULL;
          END;
          /
          
          COMMIT;
          
          -- 验证
          SELECT COUNT(*) FROM test_table;
          
          EXIT;
          EOF

      - name: Run integration tests
        run: |
          source $GITHUB_ENV
          go test -v -coverprofile=coverage.integration.txt ./test/integration/...

      - name: Combine coverage reports
        run: |
          echo "mode: atomic" > coverage.txt
          tail -n +2 coverage.unit.txt >> coverage.txt
          tail -n +2 coverage.integration.txt >> coverage.txt

      - name: Upload test coverage
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.txt
